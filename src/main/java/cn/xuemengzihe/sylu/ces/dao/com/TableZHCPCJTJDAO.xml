<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.xuemengzihe.sylu.ces.dao.com.TableZHCPCJTJDAO">
	<insert id="insertRecord" parameterType="tableZHCPCJTJ" useGeneratedKeys="true">
		INSERT INTO `t_zhcpcjtj` (
			`sno`, 
			`term_id`, 
			`ping_jun_xue_fen_ji_dian`, 
			`is_valid`, 
			`c_time`, 
			`u_time`
		) VALUES (
			#{sno},
			#{termId},
			#{pingJunXueFenJiDian},
			#{isValid},
			#{cTime},
			#{uTime}
		)
	</insert>
	<delete id="deleteRecord" parameterType="int">
		DELETE FROM `t_zhcpcjtj`
		WHERE `id` = #{value}
	</delete>
	<update id="updateRecord" parameterType="tableZHCPCJTJ">
		UPDATE `t_zhcpcjtj` SET
			`sno` = #{sno},
			`term_id` = #{termId},
			`ping_jun_xue_fen_ji_dian` = #{pingJunXueFenJiDian},
			`is_valid` = #{isValid}
		WHERE `id` = #{id}
	</update>
	<select id="getRecordById" parameterType="int" resultType="tableZHCPCJTJ">
		SELECT 
		    *
		FROM
		    (SELECT 
		        zhstu.id
		    FROM
		        (SELECT 
		        zh.id
		    FROM
		        t_zhcpcjtj zh
		    LEFT JOIN student stu ON zh.sno = stu.sno
		    WHERE
		        zh.id = '1') zhstu
		    LEFT JOIN t_szxfrcxwbfpf rcxw ON zhstu.id = rcxw.zong_he_id) zsr
		        LEFT JOIN
		    t_szjyjfpf szjf ON zsr.id = szjf.zong_he_id
	</select>
	<select id="getRecordWithMap" parameterType="map" resultType="map">
		SELECT 
		    `zsr`.*,
		    `szjf`.`id` AS `szjfId`,
			`szjf`.`she_hui_fu_wu`+
			`szjf`.`she_hui_shi_jian`+
			`szjf`.`bi_sai_huo_jiang`+
			`szjf`.`xue_sheng_gan_bu` AS `szjfScore`,
		    `szjf`.`is_valid` AS `szjfState`
		FROM
		    (SELECT 
		        `zhstu`.*,
		        `rcxw`.`id` AS `rcxwId`,
		        `rcxw`.`she_hui_gong_de`+
				`rcxw`.`wen_ming_jiao_wang`+
				`rcxw`.`cheng_xin_li_shen`+
				`rcxw`.`ti_yu_duan_lian`+
				`rcxw`.`ai_hu_gong_wu`+
				`rcxw`.`xue_xiao_gui_ding`+
				`rcxw`.`can_jia_huo_dong`+
				`rcxw`.`ting_ke_ji_lu`+
				`rcxw`.`gong_yu_jian_cha` AS `rcxwScore`,
		        `rcxw`.`is_valid` AS `rcxwState`
		    FROM
		        (SELECT 
		        	`stu`.`id` AS `stuId`,
		        	`stu`.`sno` AS `sno`,
		        	`stu`.`name` AS `name`,
					`zh`.`id` AS `id`,
					`zh`.`term_id` AS `termId`,
		            `zh`.`id` AS `zhId`,
		            `zh`.`ping_jun_xue_fen_ji_dian` AS `xfjd`,
		            `zh`.`is_valid` AS `zhState`
				FROM
					`t_zhcpcjtj` `zh`
				LEFT JOIN `student` `stu` ON `zh`.`sno` = `stu`.`sno`
				WHERE
					<if test="termId != null">
						`zh`.`term_id` = #{termId}
					</if>
					<if test="zhId != null">
						AND `zh`.`id` = #{zhId}
					</if>
					<if test="classId != null">
						AND `stu`.`class_id` = #{classId}
					</if>
				) `zhstu`
		    LEFT JOIN `t_szxfrcxwbfpf` `rcxw` ON `zhstu`.`id` = `rcxw`.`zong_he_id`
		) `zsr`
		LEFT JOIN `t_szjyjfpf` `szjf` ON `zsr`.`id` = `szjf`.`zong_he_id`
		ORDER BY 
		<choose>
			<!-- 根据成绩降序排列 -->
			<when test="order = 'score'">
				(`szjfScore`+`rcxwScore`-50)/10*0.02 + `xfjd`*0.8 DESC, `sno` ASC
			</when>
			<!-- 默认为按照学号排序 -->
			<otherwise>
				`sno`
			</otherwise>
		</choose>
	</select>
</mapper>